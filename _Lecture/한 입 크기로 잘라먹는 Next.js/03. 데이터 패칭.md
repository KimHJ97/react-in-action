# 앱 라우터 데이터 패칭

App Router에서의 데이터 패칭(Data Fetching)은 기존 Pages Router와는 달리, Server Components를 기본으로 하고, 서버에서 데이터를 불러오는 것이 기본값입니다.

 - 기본적으로 서버에서 실행되며, 브라우저에 데이터 fetching 로직이 노출되지 않음
 - cache, revalidate 옵션으로 ISR, SSR처럼 동작 조절 가능
```javascript
async function getProducts() {
  const res = await fetch("https://api.example.com/products", {
    cache: "no-store", // or 'force-cache' or 'revalidate'
  });
  return res.json();
}

export default async function ProductsPage() {
  const products = await getProducts();

  return (
    <ul>
      {products.map((p: any) => (
        <li key={p.id}>{p.name}</li>
      ))}
    </ul>
  );
}
```
<br/>

## 1. 데이터 캐시

 - fetch 메서드를 활용해 불러온 데이터를 Next 서버에서 보관하는 기능
 - 영구적으로 데이터를 보관하거나, 특정 시간을 주기로 갱신 시키는 것도 가능
 - 불필요한 데이터 요청의 수를 줄여서 웹 서비스의 성능을 크게 개선할 수 있음
```javascript
// 기본 fetch 함수: 캐싱 X
const response = await fetch(`~/api`);
const response = await fetch(`~/api`, { cache: "no-store" });

// 요청의 결과를 무조건 캐싱
// 한 번 호출된 이후에는 다시는 호출되지 않음
const response = await fetch(`~/api`, { cache: "force-cache" });

// 특정 시간을 주기로 캐시 업데이트 함
// Page Router의 ISR 방식과 유사
const response = await fetch(`~/api`, { next: { revalidate: 10 } });

// On-Demand Revalidate
// 요청이 들어왔을 때 데이터를 최신화함
const response = await fetch(`~/api`, { next: { tags: ['a'] } });
```
<br/>

## 2. 리퀘스트 메모이제이션

Next.js App Router에서의 리퀘스트 메모이제이션(Request Memoization)은 fetch()나 비동기 함수를 여러 번 호출했을 때 중복 호출을 방지하고, 결과를 메모리에 저장해 재사용하는 기능을 말한다.

 - fetch() 함수를 사용하면 자동으로 메모이제이션된다.
```javascript
// getProducts.ts
export async function getProducts() {
  const res = await fetch('https://api.example.com/products');
  return res.json();
}

// page.tsx
import { getProducts } from './getProducts';

export default async function Page() {
  const products1 = await getProducts(); // 첫 호출
  const products2 = await getProducts(); // 동일 요청, 자동 메모이제이션 (중복 fetch X)

  return <div>{products1.length}개</div>;
}
```

 - `React cache() 함수`
    - __메모이제이션(Memoization)__
        - cache는 동일한 입력(인자)에 대해 동일한 결과를 캐싱합니다.
        - 캐싱된 결과는 서버 요청 또는 컴포넌트 렌더링 주기 동안 유지됩니다.
        - 동일한 데이터를 여러 컴포넌트에서 요청하더라도, 캐싱된 결과가 재사용됩니다.
    - __서버 전용__
        - cache는 서버 사이드에서 동작하도록 설계되었습니다(React Server Components 또는 Next.js App Router).
        - 클라이언트 사이드에서는 일반적으로 React.memo나 useMemo 같은 다른 메모이제이션 도구를 사용합니다.
```javascript
// 이 함수는 동일 인자(id)로 호출될 경우 결과를 메모리에 저장하고 다시 fetch 하지 않음
// cache()는 인자 기반 메모이제이션을 하므로 동일 인자로만 동작
// 주로 Server Component에서 고정된 데이터를 여러 번 쓰는 경우 유용
import { cache } from 'react';

export const getUser = cache(async (id: string) => {
  const res = await fetch(`https://api.example.com/user/${id}`);
  return res.json();
});
```
